# Linkage Error filter plugin for Embulk

For https://github.com/embulk/embulk/issues/691

## How to expose

```
./gradlew classpath
embulk run example/config.yml -Ilib
```

## Stacktrace

```
[embulk-filter-linkage_error] embulk run example/config.yml -Ilib
2017-06-23 12:04:23.649 +0900: Embulk v0.8.25
2017-06-23 12:04:25.049 +0900 [INFO] (0001:transaction): Loaded plugin embulk/filter/linkage_error from a load path
2017-06-23 12:04:25.069 +0900 [INFO] (0001:transaction): Listing local files at directory 'example' filtering filename by prefix 'data.csv'
2017-06-23 12:04:25.070 +0900 [INFO] (0001:transaction): "follow_symlinks" is set false. Note that symbolic links to directories are skipped.
2017-06-23 12:04:25.074 +0900 [INFO] (0001:transaction): Loading files [example/data.csv]
org.embulk.exec.PartialExecutionException: java.lang.LinkageError: loader constraint violation: loader (instance of org/embulk/plugin/PluginClassLoader) previously initiated loading for a different type with name "org/msgpack/value/Value"
        at org.embulk.exec.BulkLoader$LoaderState.buildPartialExecuteException(org/embulk/exec/BulkLoader.java:375)
        at org.embulk.exec.BulkLoader.doRun(org/embulk/exec/BulkLoader.java:607)
        at org.embulk.exec.BulkLoader.access$000(org/embulk/exec/BulkLoader.java:35)
        at org.embulk.exec.BulkLoader$1.run(org/embulk/exec/BulkLoader.java:391)
        at org.embulk.exec.BulkLoader$1.run(org/embulk/exec/BulkLoader.java:387)
        at org.embulk.spi.Exec.doWith(org/embulk/spi/Exec.java:25)
        at org.embulk.exec.BulkLoader.run(org/embulk/exec/BulkLoader.java:387)
        at org.embulk.EmbulkEmbed.run(org/embulk/EmbulkEmbed.java:180)
        at java.lang.reflect.Method.invoke(java/lang/reflect/Method.java:498)
        at org.jruby.javasupport.JavaMethod.invokeDirectWithExceptionHandling(org/jruby/javasupport/JavaMethod.java:453)
        at org.jruby.javasupport.JavaMethod.invokeDirect(org/jruby/javasupport/JavaMethod.java:314)
        at RUBY.run(/Users/takahiro.nakayama/bin/embulk!/embulk/runner.rb:84)
        at RUBY.run(/Users/takahiro.nakayama/bin/embulk!/embulk/command/embulk_run.rb:269)
        at RUBY.<main>(/Users/takahiro.nakayama/bin/embulk!/embulk/command/embulk_main.rb:2)
        at org.jruby.Ruby.runInterpreter(org/jruby/Ruby.java:850)
        at org.jruby.Ruby.loadFile(org/jruby/Ruby.java:2976)
        at org.jruby.RubyKernel.requireCommon(org/jruby/RubyKernel.java:963)
        at org.jruby.RubyKernel.require(org/jruby/RubyKernel.java:956)
        at org.jruby.RubyKernel$INVOKER$s$1$0$require19.call(org/jruby/RubyKernel$INVOKER$s$1$0$require19.gen)
        at RUBY.(root)(uri:classloader:/META-INF/jruby.home/lib/ruby/stdlib/rubygems/core_ext/kernel_require.rb:1)
        at Users.takahiro_dot_nakayama.bin.embulk.embulk.command.embulk_bundle.invokeOther34:require(Users/takahiro_dot_nakayama/bin/embulk/embulk/command/file:/Users/takahiro.nakayama/bin/embulk!/embulk/command/embulk_bundle.rb:46)
        at Users.takahiro_dot_nakayama.bin.embulk.embulk.command.embulk_bundle.<main>(file:/Users/takahiro.nakayama/bin/embulk!/embulk/command/embulk_bundle.rb:46)
        at java.lang.invoke.MethodHandle.invokeWithArguments(java/lang/invoke/MethodHandle.java:627)
        at org.jruby.Ruby.runScript(org/jruby/Ruby.java:834)
        at org.jruby.Ruby.runNormally(org/jruby/Ruby.java:749)
        at org.jruby.Ruby.runNormally(org/jruby/Ruby.java:767)
        at org.jruby.Ruby.runFromMain(org/jruby/Ruby.java:580)
        at org.jruby.Main.doRunFromMain(org/jruby/Main.java:425)
        at org.jruby.Main.internalRun(org/jruby/Main.java:313)
        at org.jruby.Main.run(org/jruby/Main.java:242)
        at org.jruby.Main.main(org/jruby/Main.java:204)
        at org.embulk.cli.Main.main(org/embulk/cli/Main.java:23)
        Suppressed: java.lang.NullPointerException
                at org.embulk.exec.BulkLoader.doCleanup(BulkLoader.java:496)
                at org.embulk.exec.BulkLoader$3.run(BulkLoader.java:427)
                at org.embulk.exec.BulkLoader$3.run(BulkLoader.java:423)
                at org.embulk.spi.Exec.doWith(Exec.java:25)
                at org.embulk.exec.BulkLoader.cleanup(BulkLoader.java:423)
                at org.embulk.EmbulkEmbed.run(EmbulkEmbed.java:184)
                at sun.reflect.NativeMethodAccessorImpl.invoke0(Native Method)
                at sun.reflect.NativeMethodAccessorImpl.invoke(NativeMethodAccessorImpl.java:62)
                at sun.reflect.DelegatingMethodAccessorImpl.invoke(DelegatingMethodAccessorImpl.java:43)
                at java.lang.reflect.Method.invoke(Method.java:498)
                at org.jruby.javasupport.JavaMethod.invokeDirectWithExceptionHandling(JavaMethod.java:453)
                at org.jruby.javasupport.JavaMethod.invokeDirect(JavaMethod.java:314)
                at org.jruby.java.invokers.InstanceMethodInvoker.call(InstanceMethodInvoker.java:46)
                at org.jruby.runtime.callsite.CachingCallSite.cacheAndCall(CachingCallSite.java:338)
                at org.jruby.runtime.callsite.CachingCallSite.call(CachingCallSite.java:163)
                at org.jruby.ir.interpreter.InterpreterEngine.processCall(InterpreterEngine.java:315)
                at org.jruby.ir.interpreter.StartupInterpreterEngine.interpret(StartupInterpreterEngine.java:73)
                at org.jruby.ir.interpreter.InterpreterEngine.interpret(InterpreterEngine.java:90)
                at org.jruby.internal.runtime.methods.MixedModeIRMethod.INTERPRET_METHOD(MixedModeIRMethod.java:214)
                at org.jruby.internal.runtime.methods.MixedModeIRMethod.call(MixedModeIRMethod.java:200)
                at org.jruby.internal.runtime.methods.DynamicMethod.call(DynamicMethod.java:205)
                at org.jruby.runtime.callsite.CachingCallSite.cacheAndCall(CachingCallSite.java:358)
                at org.jruby.runtime.callsite.CachingCallSite.call(CachingCallSite.java:195)
                at org.jruby.ir.interpreter.InterpreterEngine.processCall(InterpreterEngine.java:324)
                at org.jruby.ir.interpreter.StartupInterpreterEngine.interpret(StartupInterpreterEngine.java:73)
                at org.jruby.ir.interpreter.InterpreterEngine.interpret(InterpreterEngine.java:84)
                at org.jruby.internal.runtime.methods.MixedModeIRMethod.INTERPRET_METHOD(MixedModeIRMethod.java:179)
                at org.jruby.internal.runtime.methods.MixedModeIRMethod.call(MixedModeIRMethod.java:165)
                at org.jruby.internal.runtime.methods.DynamicMethod.call(DynamicMethod.java:197)
                at org.jruby.runtime.callsite.CachingCallSite.cacheAndCall(CachingCallSite.java:338)
                at org.jruby.runtime.callsite.CachingCallSite.call(CachingCallSite.java:163)
                at org.jruby.ir.interpreter.InterpreterEngine.processCall(InterpreterEngine.java:315)
                at org.jruby.ir.interpreter.StartupInterpreterEngine.interpret(StartupInterpreterEngine.java:73)
                at org.jruby.ir.interpreter.Interpreter.INTERPRET_ROOT(Interpreter.java:112)
                at org.jruby.ir.interpreter.Interpreter.execute(Interpreter.java:99)
                at org.jruby.ir.interpreter.Interpreter.execute(Interpreter.java:35)
                at org.jruby.ir.IRTranslator.execute(IRTranslator.java:42)
                at org.jruby.Ruby.runInterpreter(Ruby.java:850)
                at org.jruby.Ruby.loadFile(Ruby.java:2976)
                at org.jruby.runtime.load.LibrarySearcher$ResourceLibrary.load(LibrarySearcher.java:243)
                at org.jruby.runtime.load.LibrarySearcher$FoundLibrary.load(LibrarySearcher.java:34)
                at org.jruby.runtime.load.LoadService.tryLoadingLibraryOrScript(LoadService.java:885)
                at org.jruby.runtime.load.LoadService.smartLoadInternal(LoadService.java:525)
                at org.jruby.runtime.load.LoadService.require(LoadService.java:396)
                at org.jruby.RubyKernel.requireCommon(RubyKernel.java:963)
                at org.jruby.RubyKernel.require19(RubyKernel.java:956)
                at org.jruby.RubyKernel$INVOKER$s$1$0$require19.call(RubyKernel$INVOKER$s$1$0$require19.gen)
                at org.jruby.internal.runtime.methods.JavaMethod$JavaMethodOneOrNBlock.call(JavaMethod.java:383)
                at org.jruby.internal.runtime.methods.AliasMethod.call(AliasMethod.java:61)
                at org.jruby.runtime.callsite.CachingCallSite.call(CachingCallSite.java:161)
                at org.jruby.ir.interpreter.InterpreterEngine.processCall(InterpreterEngine.java:315)
                at org.jruby.ir.interpreter.StartupInterpreterEngine.interpret(StartupInterpreterEngine.java:73)
                at org.jruby.ir.interpreter.InterpreterEngine.interpret(InterpreterEngine.java:84)
                at org.jruby.internal.runtime.methods.MixedModeIRMethod.INTERPRET_METHOD(MixedModeIRMethod.java:179)
                at org.jruby.internal.runtime.methods.MixedModeIRMethod.call(MixedModeIRMethod.java:165)
                at org.jruby.internal.runtime.methods.DynamicMethod.call(DynamicMethod.java:197)
                at org.jruby.runtime.callsite.CachingCallSite.cacheAndCall(CachingCallSite.java:338)
                at org.jruby.runtime.callsite.CachingCallSite.call(CachingCallSite.java:163)
                at Users.takahiro_dot_nakayama.bin.embulk.embulk.command.embulk_bundle.invokeOther34:require(file:/Users/takahiro.nakayama/bin/embulk!/embulk/command/embulk_bundle.rb:46)
                at Users.takahiro_dot_nakayama.bin.embulk.embulk.command.embulk_bundle.RUBY$script(file:/Users/takahiro.nakayama/bin/embulk!/embulk/command/embulk_bundle.rb:46)
                at java.lang.invoke.MethodHandle.invokeWithArguments(MethodHandle.java:627)
                at org.jruby.ir.Compiler$1.load(Compiler.java:111)
                at org.jruby.Ruby.runScript(Ruby.java:834)
                at org.jruby.Ruby.runNormally(Ruby.java:749)
                at org.jruby.Ruby.runNormally(Ruby.java:767)
                at org.jruby.Ruby.runFromMain(Ruby.java:580)
                at org.jruby.Main.doRunFromMain(Main.java:425)
                at org.jruby.Main.internalRun(Main.java:313)
                at org.jruby.Main.run(Main.java:242)
                at org.jruby.Main.main(Main.java:204)
                at org.embulk.cli.Main.main(Main.java:23)
Caused by: java.lang.LinkageError: loader constraint violation: loader (instance of org/embulk/plugin/PluginClassLoader) previously initiated loading for a different type with name "org/msgpack/value/Value"
        at java.lang.ClassLoader.defineClass1(Native Method)
        at java.lang.ClassLoader.defineClass(ClassLoader.java:763)
        at java.security.SecureClassLoader.defineClass(SecureClassLoader.java:142)
        at java.net.URLClassLoader.defineClass(URLClassLoader.java:467)
        at java.net.URLClassLoader.access$100(URLClassLoader.java:73)
        at java.net.URLClassLoader$1.run(URLClassLoader.java:368)
        at java.net.URLClassLoader$1.run(URLClassLoader.java:362)
        at java.security.AccessController.doPrivileged(Native Method)
        at java.net.URLClassLoader.findClass(URLClassLoader.java:361)
        at org.embulk.plugin.PluginClassLoader.loadClass(PluginClassLoader.java:72)
        at java.lang.ClassLoader.loadClass(ClassLoader.java:357)
        at org.embulk.filter.linkage_error.LinkageErrorFilterPlugin.transaction(LinkageErrorFilterPlugin.java:30)
        at org.embulk.spi.util.Filters$RecursiveControl.transaction(Filters.java:87)
        at org.embulk.spi.util.Filters.transaction(Filters.java:49)
        at org.embulk.exec.BulkLoader$4.run(BulkLoader.java:549)
        at org.embulk.spi.FileInputRunner$RunnerControl$1$1.run(FileInputRunner.java:126)
        at org.embulk.standards.CsvParserPlugin.transaction(CsvParserPlugin.java:225)
        at org.embulk.spi.FileInputRunner$RunnerControl$1.run(FileInputRunner.java:120)
        at org.embulk.spi.util.Decoders$RecursiveControl.transaction(Decoders.java:77)
        at org.embulk.spi.util.Decoders.transaction(Decoders.java:33)
        at org.embulk.spi.FileInputRunner$RunnerControl.run(FileInputRunner.java:117)
        at org.embulk.standards.LocalFileInputPlugin.resume(LocalFileInputPlugin.java:87)
        at org.embulk.standards.LocalFileInputPlugin.transaction(LocalFileInputPlugin.java:77)
        at org.embulk.spi.FileInputRunner.transaction(FileInputRunner.java:67)
        at org.embulk.exec.BulkLoader.doRun(BulkLoader.java:544)
        at org.embulk.exec.BulkLoader.access$000(BulkLoader.java:35)
        at org.embulk.exec.BulkLoader$1.run(BulkLoader.java:391)
        at org.embulk.exec.BulkLoader$1.run(BulkLoader.java:387)
        at org.embulk.spi.Exec.doWith(Exec.java:25)
        at org.embulk.exec.BulkLoader.run(BulkLoader.java:387)
        at org.embulk.EmbulkEmbed.run(EmbulkEmbed.java:180)
        at sun.reflect.NativeMethodAccessorImpl.invoke0(Native Method)
        at sun.reflect.NativeMethodAccessorImpl.invoke(NativeMethodAccessorImpl.java:62)
        at sun.reflect.DelegatingMethodAccessorImpl.invoke(DelegatingMethodAccessorImpl.java:43)
        at java.lang.reflect.Method.invoke(Method.java:498)
        at org.jruby.javasupport.JavaMethod.invokeDirectWithExceptionHandling(JavaMethod.java:453)
        at org.jruby.javasupport.JavaMethod.invokeDirect(JavaMethod.java:314)
        at org.jruby.java.invokers.InstanceMethodInvoker.call(InstanceMethodInvoker.java:46)
        at org.jruby.runtime.callsite.CachingCallSite.cacheAndCall(CachingCallSite.java:338)
        at org.jruby.runtime.callsite.CachingCallSite.call(CachingCallSite.java:163)
        at org.jruby.ir.interpreter.InterpreterEngine.processCall(InterpreterEngine.java:315)
        at org.jruby.ir.interpreter.StartupInterpreterEngine.interpret(StartupInterpreterEngine.java:73)
        at org.jruby.ir.interpreter.InterpreterEngine.interpret(InterpreterEngine.java:90)
        at org.jruby.internal.runtime.methods.MixedModeIRMethod.INTERPRET_METHOD(MixedModeIRMethod.java:214)
        at org.jruby.internal.runtime.methods.MixedModeIRMethod.call(MixedModeIRMethod.java:200)
        at org.jruby.internal.runtime.methods.DynamicMethod.call(DynamicMethod.java:205)
        at org.jruby.runtime.callsite.CachingCallSite.cacheAndCall(CachingCallSite.java:358)
        at org.jruby.runtime.callsite.CachingCallSite.call(CachingCallSite.java:195)
        at org.jruby.ir.interpreter.InterpreterEngine.processCall(InterpreterEngine.java:324)
        at org.jruby.ir.interpreter.StartupInterpreterEngine.interpret(StartupInterpreterEngine.java:73)
        at org.jruby.ir.interpreter.InterpreterEngine.interpret(InterpreterEngine.java:84)
        at org.jruby.internal.runtime.methods.MixedModeIRMethod.INTERPRET_METHOD(MixedModeIRMethod.java:179)
        at org.jruby.internal.runtime.methods.MixedModeIRMethod.call(MixedModeIRMethod.java:165)
        at org.jruby.internal.runtime.methods.DynamicMethod.call(DynamicMethod.java:197)
        at org.jruby.runtime.callsite.CachingCallSite.cacheAndCall(CachingCallSite.java:338)
        at org.jruby.runtime.callsite.CachingCallSite.call(CachingCallSite.java:163)
        at org.jruby.ir.interpreter.InterpreterEngine.processCall(InterpreterEngine.java:315)
        at org.jruby.ir.interpreter.StartupInterpreterEngine.interpret(StartupInterpreterEngine.java:73)
        at org.jruby.ir.interpreter.Interpreter.INTERPRET_ROOT(Interpreter.java:112)
        at org.jruby.ir.interpreter.Interpreter.execute(Interpreter.java:99)
        at org.jruby.ir.interpreter.Interpreter.execute(Interpreter.java:35)
        at org.jruby.ir.IRTranslator.execute(IRTranslator.java:42)
        at org.jruby.Ruby.runInterpreter(Ruby.java:850)
        at org.jruby.Ruby.loadFile(Ruby.java:2976)
        at org.jruby.runtime.load.LibrarySearcher$ResourceLibrary.load(LibrarySearcher.java:243)
        at org.jruby.runtime.load.LibrarySearcher$FoundLibrary.load(LibrarySearcher.java:34)
        at org.jruby.runtime.load.LoadService.tryLoadingLibraryOrScript(LoadService.java:885)
        at org.jruby.runtime.load.LoadService.smartLoadInternal(LoadService.java:525)
        at org.jruby.runtime.load.LoadService.require(LoadService.java:396)
        at org.jruby.RubyKernel.requireCommon(RubyKernel.java:963)
        at org.jruby.RubyKernel.require19(RubyKernel.java:956)
        at org.jruby.RubyKernel$INVOKER$s$1$0$require19.call(RubyKernel$INVOKER$s$1$0$require19.gen)
        at org.jruby.internal.runtime.methods.JavaMethod$JavaMethodOneOrNBlock.call(JavaMethod.java:383)
        at org.jruby.internal.runtime.methods.AliasMethod.call(AliasMethod.java:61)
        at org.jruby.runtime.callsite.CachingCallSite.call(CachingCallSite.java:161)
        at org.jruby.ir.interpreter.InterpreterEngine.processCall(InterpreterEngine.java:315)
        at org.jruby.ir.interpreter.StartupInterpreterEngine.interpret(StartupInterpreterEngine.java:73)
        at org.jruby.ir.interpreter.InterpreterEngine.interpret(InterpreterEngine.java:84)
        at org.jruby.internal.runtime.methods.MixedModeIRMethod.INTERPRET_METHOD(MixedModeIRMethod.java:179)
        at org.jruby.internal.runtime.methods.MixedModeIRMethod.call(MixedModeIRMethod.java:165)
        at org.jruby.internal.runtime.methods.DynamicMethod.call(DynamicMethod.java:197)
        at org.jruby.runtime.callsite.CachingCallSite.cacheAndCall(CachingCallSite.java:338)
        at org.jruby.runtime.callsite.CachingCallSite.call(CachingCallSite.java:163)
        at Users.takahiro_dot_nakayama.bin.embulk.embulk.command.embulk_bundle.invokeOther34:require(file:/Users/takahiro.nakayama/bin/embulk!/embulk/command/embulk_bundle.rb:46)
        at Users.takahiro_dot_nakayama.bin.embulk.embulk.command.embulk_bundle.RUBY$script(file:/Users/takahiro.nakayama/bin/embulk!/embulk/command/embulk_bundle.rb:46)
        at java.lang.invoke.MethodHandle.invokeWithArguments(MethodHandle.java:627)
        at org.jruby.ir.Compiler$1.load(Compiler.java:111)
        at org.jruby.Ruby.runScript(Ruby.java:834)
        at org.jruby.Ruby.runNormally(Ruby.java:749)
        at org.jruby.Ruby.runNormally(Ruby.java:767)
        at org.jruby.Ruby.runFromMain(Ruby.java:580)
        at org.jruby.Main.doRunFromMain(Main.java:425)
        at org.jruby.Main.internalRun(Main.java:313)
        at org.jruby.Main.run(Main.java:242)
        at org.jruby.Main.main(Main.java:204)
        at org.embulk.cli.Main.main(Main.java:23)

Error: java.lang.LinkageError: loader constraint violation: loader (instance of org/embulk/plugin/PluginClassLoader) previously initiated loading for a different type with name "org/msgpack/value/Value"

```
